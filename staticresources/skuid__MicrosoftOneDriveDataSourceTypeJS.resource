!function(a){var b=a.$,c=b.map,d=b.each,e=b.Deferred,f=b.ajax,g=a.utils,h=a.dataSource,i=a.constants,j=i.DISPLAY_TYPES,k=i.MIME_TYPES,l=i.HTTP_VERBS,m=k.JSON,n=j.DATETIME,o=j.NUMBER,p=j.OBJECT,q=j.STRING,r=l.GET,s=l.PATCH,t=l.DELETE,u=function(a,b){var c={};return d(a,function(a,d){d.inactive||(c[d.sourceParam||d.name]=encodeURI(g.mergeAsTextInContext(d.value,b)))}),c},v=function(a){var b,c,d=a.model,e=d.conditions,f=u(e,a),g=f.__default_searchbox,h=f["Parent Folder"],i=f.extension||"";h?-1===h.indexOf("/")?c="/_api/v2.0/drive/items/"+h+"/children":(h=h.split(" ").join("%20"),b=h.split("/"),c="/_api/v2.0/drive/root:"+h,i||-1!==b[b.length-1].indexOf(".")||(c+=":/children")):c="/_api/v2.0/drive/root/children",g&&(c=h&&-1===h.indexOf("/")?"/_api/v2.0/drive/items/"+h+"/view.search?q="+g:"/_api/v2.0/drive/root/view.search?q="+g),a.request.url=c};h.getDataSourceType("MicrosoftOneDrive")||new h.core.RESTDataSourceTypeBase({name:"MicrosoftOneDrive",coerceRequest:function(a){var b=a.type,c=a.request.data;if("query"===b)v(a);else if(("update"===b||"delete"===b)&&(a.request.url="/_api/v2.0/drive/items/"+a.originalRecordId,"update"===b)){var d=c.parentDirectory||"";a.request.data.parentReference={path:"/drive/root:"+d},delete a.request.data.parentDirectory}a.request.headers={Accept:m}},parseSuccessfulLoadResponse:function(a,c,d,e){var f,h,i,j,k=this,l=k.parseResponseBodyAsJSON(a.body),m=c.pathToContent,n=e.conditions,o=[];if(b.each(n,function(a,b){"extension"===b.name?f=b.value:"Parent Folder"===b.name&&(h=b.value,i=h.split("/"))}),j=h&&-1!==i[i.length-1].indexOf(".")?l:m?g.getObjectProperty(l,m):l,b.isArray(j))b.each(j,function(a,b){var c;if(f){var d=b.name.split(".");c=d?d.slice(-1)[0]:""}if(f&&-1===c.indexOf(f))delete j[a];else{var e=b.parentReference.path,h=e?e.split(":")[1]:b.parentReference.id;b.createdByUserName=g.getObjectProperty(b,"createdBy.user.displayName"),b.lastModifiedByUserName=g.getObjectProperty(b,"lastModifiedBy.user.displayName"),b.parentDirectory=h,b.oneUp=h.substring(0,h.lastIndexOf("/")),o.push(b)}}),d.data=o,j=o;else{var p=j.parentReference.path,q=p?p.split(":")[1]:j.parentReference.id;j.createdByUserName=g.getObjectProperty(j,"createdBy.user.displayName"),j.lastModifiedByUserName=g.getObjectProperty(j,"lastModifiedBy.user.displayName"),j.parentDirectory=q,j.oneUp=q.substring(0,q.lastIndexOf("/")),d.data=j=[j]}},getEntityList:function(){var a=b.Deferred(),d=this.prop("x-metadata");return a.resolve(c(d,function(a,b){return{value:b,label:a.label}})).promise()},getUploadMethods:function(){function b(b,c,e,f,h,i){function j(a){if(a&&a.body){var b=a.body;if(b&&b.error&&b.error.message)return b.error.message}return"Had an error"}function k(){var a;f({fileName:e.filename||b.name}),a=r&&-1===r.indexOf("/")?z+"/_api/v2.0/drive/items/"+r+":/"+u+":/upload.createSession":r&&"/"!==r?z+"/_api/v2.0/drive/root:"+r+"/"+u+":/upload.createSession":z+"/_api/v2.0/drive/root:/"+u+":/createUploadSession";var c=x.createHTTPRequest({url:a,method:"POST",headers:{"Content-Length":0,Accept:m}});return x.makeRequest(c)}function l(){var a=atob(t[0]).length-1;return i({loaded:C,total:s}),x.makeRequest(x.createHTTPRequest({url:q,headers:{"Content-Range":"bytes 0-"+a+"/"+A,"Content-Length":t[0].length,Accept:m},contentType:"application/octet-stream",method:"PUT",body:t[0]})).then(function(a){1===s?h():n(a)},function(a){h({message:j(a)})})}function n(a){C++,i({loaded:C,total:s}),x.authenticate(e).then(function(){if(C===s)o(a);else{var b="string"==typeof a.body?JSON.parse(a.body):a.body,c=b.nextExpectedRanges[0].split("-")[0],d=parseInt(c,10)+atob(t[C-1]).length-1;x.makeRequest(x.createHTTPRequest({url:q,headers:{"Content-Range":"bytes "+c+"-"+d+"/"+A,"Content-Length":t[C-1].length,Accept:m},contentType:"application/octet-stream",method:"PUT",body:t[C-1]})).then(function(a){n(a)},function(a){h({message:j(a)})})}})}function o(a){var b="string"==typeof a.body?JSON.parse(a.body):a.body,c=b.nextExpectedRanges[0].split("-")[0],d=parseInt(c,10)+atob(t[C-1]).length-1;x.makeRequest(x.createHTTPRequest({url:q,headers:{"Content-Range":"bytes "+c+"-"+d+"/"+A,"Content-Length":t[C-1].length,Accept:m},contentType:"application/octet-stream",method:"PUT",body:t[C-1]})).then(function(a){202===a.statusCode?h({message:"Upload failed!"}):h()},function(a){h({message:j(a)})})}function p(a,b){for(var c=a.length,d=[],e=Math.ceil(c/b),f=0;f<b;f++)d[f]=btoa(a.slice(e*f,e*(f+1)));return d}var q,r,s,t,u=encodeURIComponent(g.renameFileWhileKeepingExtension(b.name,g.mergeAsTextInContext(e.filename,e))),v=new FileReader,w=e.model,x=w.dataSource,y=w.conditions,z=x.serviceUrl,A=b.size,B=a.platform.getMaxProxyRequestPayload(),C=1;d(y,function(a,b){r=b.value||""}),v.readAsBinaryString(b),v.onloadend=function(){t=v.result,s=Math.ceil(A/B),x.authenticate(e).then(function(){t=p(t,s),k().then(function(a){var b="string"==typeof a.body?JSON.parse(a.body):a.body;q=b.uploadUrl,l()},function(a){h({message:j(a)})})})}}return{"Direct Upload":{label:"Direct Upload",canRunPostUploadSnippet:!0,hasName:!1,upload:b,needsModelInContext:!0}}},queryEntityMetadata:function(a){var c=this.getEntityMetadataCacheKey(a),d=this.prop("x-metadata")[c];return b.Deferred().resolve(d)},getActions:function(a,b){var c=e(),d=this;return c.resolve(d.createActions(a,b)),c.promise()},createActions:function(b){return{"create-folder":{label:"Create new folder",builderProps:[{label:"Model with Parent Folder Condition",id:"model",type:"model",helptext:"Will take the value in this model's parent folder condition, and use it as the parent folder for the new folder",entryFilter:g.filterByDataSourceAndEntity(b.name,"File")},{label:"Folder Name",id:"foldername",type:"string"}],runnableFunction:function(b,c,h,i){var j,k=a.$M(b.attr("model")),l=k.dataSource,m=l.serviceUrl,n="",o=g.mergeAsTextInContext(b.attr("foldername"),h),p=e();return d(k.conditions,function(a,b){"Parent Folder"===b.sourceParam&&(n=g.mergeAsTextInContext(b.value,h)||n)}),j={name:o,folder:{},"@name.conflictBehavior":"rename"},f(n&&-1===n.indexOf("/")?{url:m+"/_api/v2.0/drive/items/"+n+"/children",headers:{Authorization:"Bearer "+i.authentication.responseBody.access_token,"Content-Type":"application/json"},method:"POST",dataType:"json",data:JSON.stringify(j),success:function(){p.resolve()},error:function(a){p.reject(a)}}:{url:m+"/_api/v2.0/drive/root:"+n,headers:{Authorization:"Bearer "+i.authentication.responseBody.access_token},method:"GET",dataType:"json",success:function(a){f({url:m+"/_api/v2.0/drive/items/"+a.id+"/children",headers:{Authorization:"Bearer "+i.authentication.responseBody.access_token,"Content-Type":"application/json"},method:"POST",dataType:"json",data:JSON.stringify(j),success:function(){p.resolve()},error:function(a){p.reject(a)}})},error:function(a){p.reject(a)}}),p.promise()}},copy:{label:"Copy a File",builderProps:[{label:"Model with Parent Folder Condition",id:"model",type:"model",helptext:"Will take the value in this model's parent folder condition, and use it as the parent folder for the new folder",entryFilter:g.filterByDataSourceAndEntity(b.name,"File")},{label:"File Name",id:"filename",type:"string"}],runnableFunction:function(b,c,h){var i,j,k=a.$M(b.attr("model")),l=h.row,m=l.parentReference.path,n=m?m.split(":")[1]:l.parentReference.id,o=k.dataSource,p=o.serviceUrl,q="",r=g.mergeAsTextInContext(b.attr("filename"),h),s=e();return d(k.conditions,function(a,b){"Parent Folder"===b.sourceParam&&(q=g.mergeAsTextInContext(b.value,h)||q)}),j={parentReference:l.parentReference,name:r},i=q?q&&-1===q.indexOf("/")?p+"/_api/v2.0/drive/items/"+l.id+"/action.copy":p+"/_api/v2.0/drive/root:"+n+"/"+l.name+":/action.copy":p+"/_api/v2.0/drive/root:/"+l.name+":/action.copy",f({url:i,headers:{Authorization:"Bearer "+o.authentication.responseBody.access_token,"Content-Type":"application/json",Prefer:"response-async"},method:"POST",dataType:"json",data:JSON.stringify(j),success:function(){s.resolve()},error:function(a){s.reject(a)}}),s.promise()}}}},runAction:function(a,c,d,e,f){var g=b.Deferred();return f.getActions(f).then(function(b){b[a]&&b[a].runnableFunction(c,d,e,f).then(function(a){g.resolve(a)},function(a){g.reject(a)})}),g.promise()},extendedProperties:{composer:{unomittableFields:!0,hasEntityOptions:!0},hasDefaultSearch:!0,canServerSearch:!0,hasGlobalSearchEntities:!0,"x-metadata":{File:{idFields:["id"],nameField:"name",label:"File",labelPlural:"Files",fields:[{id:"id",label:"Id",displaytype:q,inlineHelpText:"Identifier of the drive.",accessible:!0,createable:!1,editable:!1,"x-alwaysinclude":!0},{id:"name",label:"Name",displaytype:q,inlineHelpText:"Name of the drive.",accessible:!0,createable:!1,editable:!0},{id:"createdByUserName",label:"Created By",displaytype:q,accessible:!0,createable:!1,editable:!1},{id:"createdDateTime",label:"Created Date Time",displaytype:n,accessible:!0,createable:!1,editable:!1},{id:"lastModifiedByUserName",label:"Last Modified By",displaytype:q,accessible:!0,createable:!1,editable:!1},{id:"lastModifiedDateTime",label:"Last Modified",displaytype:n,accessible:!0,createable:!1,editable:!1},{id:"webUrl",label:"Web Url",displaytype:q,accessible:!0,createable:!1,editable:!1},{id:"parentReference",label:"Parent Reference",displaytype:p,accessible:!1,createable:!1,editable:!1},{id:"size",label:"Size",displaytype:o,accessible:!0,createable:!1,editable:!1},{id:"parentDirectory",label:"Parent Directory",displaytype:q,accessible:!0,createable:!1,editable:!0},{id:"oneUp",label:"Directory Up",displaytype:q,accessible:!0,createable:!1,editable:!1}],methods:{query:{url:"",verb:r,contentType:m,pathToContent:"value"},update:{url:"",verb:s,contentType:m,receiveDataAs:"recordinbody",successIf:"responsefieldispresent",successField:"name"},"delete":{url:"",verb:t,contentType:m},search:{url:"/_api/v2.0/drive/root/view.search?q={{search}}",verb:r,contentType:m,pathToContent:"value"}},defaultConditions:[{sourcetype:"param",sourceparam:"Parent Folder",name:"Parent Folder",label:"Path to File/Folder",state:"filterableon",value:""},{sourcetype:"param",sourceparam:"extension",name:"extension",label:"File Extension",state:"filterableon",value:""}]}}}})}(skuid);