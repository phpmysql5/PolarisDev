!function(a){if(!a.dataSource.getType("Sharepoint")){var b=a.$,c=a.utils,d=c.makeXMLDoc,e=c.mergeAsTextInContext,f={getKeyFields:function(a){var c,d,e={},f=a.key;return b.isArray(f)&&(f=f[0]),f&&f.propertyRef&&(c=f.propertyRef[0].name,d=a.propertyMap[c],"Edm.Boolean"===d.type&&(f.propertyRef[0].name="ID"),b.each(f.propertyRef,function(a,b){e[b.name]={id:b.name}})),e},coerceSaveItemRequest:function(a){return a},isDefFilterable:function(a){return"Edm.String"===a.type&&"BaseName"!==a.name},coerceChanges:function(a,c,d){["inserts","updates","deletes"].forEach(function(c){a[c]&&b.each(a[c],function(a,b){b&&!b.__metadata&&(b.__metadata=d.getRowById(a).__metadata)})})}},g=function(){return a.dataSource.getType("OData")&&b.extend({},a.dataSource.getType("OData"),f)},h=function(){return g()?b.Deferred().resolve().promise():c.loadJS(c.getStaticResourceUrl("models/oDataDataSourceType.js","skuid",undefined,c.getCacheTimestamp()))},i=function(a){return"SkuidSharepoint-"+a+"-Login-"},j=function(a){if(!a)return"Error";var b=a.body,c=d(b),e=c.children("m\\:code").first().text().split(",");return e[1]&&e[1].trim&&e[1].trim()},k=function(a){if(a){var c=i(a.name);b.removeCookie(c+"FedAuth"),b.removeCookie(c+"rtFa"),b.removeCookie(c+"Digest"),a.authentication.success=!1,a.removeStoredAuthData()}},l=function(a){var c=b.Deferred(),d=a.dataSource,e=function(){var a=d.authentication;return"apex"===a.authMethod&&"Sharepoint_SharedLogin"===a.providerName},f=i(d.name),g=function(){a.headers||(a.headers={}),b.cookie.raw=!0,a.headers.Cookie="FedAuth="+b.cookie(f+"FedAuth")+"; rtFa="+b.cookie(f+"rtFa")+";",a.headers["X-RequestDigest"]=b.cookie(f+"Digest"),b.cookie.raw=!1};return!d.isAuthenticated()&&e()&&function(){return b.cookie(f+"FedAuth")&&b.cookie(f+"rtFa")&&b.cookie(f+"Digest")}()&&(d.authentication.success=!0),d.authenticate().done(function(){d.isAuthenticated()&&e()&&g(),c.resolve(a)}).fail(function(a){k(d),c.reject(a)}),c.promise()},m=function(a,c,d){d||(d={});var e=b.Deferred(),f=function(a){d.handleSuccess&&d.handleSuccess(a),e.resolve(a)},g=function(a){d.handleFail&&d.handleFail(a),e.reject(a)};return a().then(function(a){f(a)},function(d,e){var h=e&&e.length?e[0]:e||{};"System.UnauthorizedAccessException"===j(h)||-1!==b.inArray(h.statusCode,[401,403])?(k(c.dataSource),l(c).then(function(){a().done(function(a){f(a)}).fail(function(a){g(a)})})):g(d)}),e.promise()},n={name:"Sharepoint",save:function(a,b){return h().then(function(){return l(b)}).then(function(b){return m(function(){return g().save(a,b)},b)})},load:function(a,c){return b.extend(c,{dataSource:a[0].dataSource}),h().then(function(){return l(c)}).then(function(c){return m(function(){return g().load(a,b.extend({headers:{DataServiceVersion:"3.0"}},c))},c)},function(a){return b.Deferred().reject(a).promise()})},getEntityList:function(a){return h().then(function(){return l(a)}).then(function(a){return a||(a={}),b.extend(a,{entityContainer:"ListData"}),m(function(){return g().getEntityList(a)},a,{handleSuccess:function(a){a.push("SP.Files")}})})},buildEntityMetadataRequest:function(a){var b=a.targetEntity;return!b&&a.model&&a.model.attr&&(b=a.model.attr("sobject")),{objectName:b}},getEntityMetadataLoadingMessageFromBreadcrumb:function(a){return"Loading metadata for external object "+a.endsobject+"..."},getEntityMetadataCacheKey:function(a){return c.isString(a)?a:a.objectName},getEntityMetadata:function(a){return h().then(function(){return l(a)}).then(function(a){return m(function(){return g().getEntityMetadata(a)},a)})},getNameField:function(a){return g().getNameField(a)},getModelProperties:function(a,b){return g().getModelProperties(a,b)},getRowId:function(a,b,c){return g().getRowId(a,b,c)},properties:{canAutoGenerateConditionsFromFields:!0,validConditionTypes:["fieldvalue"],canConditionsBeGrouped:!0,composer:{canFieldsBeSelected:function(a){return!!a.breadcrumb.endsobject||"Select a Sharepoint entity for this Model."}}},getUploadMethods:function(){function d(d,f,g,h,i,j){function k(a,b){for(var c=a.length,d=[],e=Math.ceil(c/b),f=0;f<b;f++)d[f]=a.slice(e*f,e*(f+1));return d}function m(a){if(a&&a.body){var b=JSON.parse(a.body);if(b&&b.error&&b.error.message&&b.error.message.value)return b.error.message.value}return"Had an error"}function n(a,c){c||(c={}),c=b.extend({overwrite:!1},c);var e=c.overwrite;h({fileName:g.filename||d.name});var f=v+"/web/getfolderbyserverrelativeurl('"+z+"')/files/add(overwrite="+e+",url='"+t+"')",i=u.createHTTPRequest({url:f,headers:g.headers,method:"POST",contentType:"application/octet-stream",body:a});return u.makeRequest(i)}function o(){j({loaded:E,total:r});var a=v+A+"startupload(uploadId=guid'"+B+"')",b=u.createHTTPRequest({url:a,headers:g.headers,method:"POST",contentType:"application/octet-stream",body:s[0]});return u.makeRequest(b).then(function(a){p(a)},function(a){i({message:m(a)})})}function p(a){var b=JSON.parse(a.body).d,c=b.StartUpload?parseInt(b.StartUpload):parseInt(b.ContinueUpload);E++,j({loaded:E,total:r}),l(g).then(function(){if(g.headers.Accept="application/json; odata=verbose",E===r)q(c);else{var a=v+A+"continueupload(uploadId=guid'"+B+"',fileOffset="+c+")",b=u.createHTTPRequest({url:a,headers:g.headers,method:"POST",contentType:"application/octet-stream",body:s[E-1]});u.makeRequest(b).then(p,function(a){i({message:m(a)})})}})}function q(a){var b=v+A+"finishupload(uploadId=guid'"+B+"',fileOffset="+a+")",c=u.createHTTPRequest({url:b,headers:g.headers,method:"POST",contentType:"application/octet-stream",body:s[E-1]});u.makeRequest(c).then(function(){i()},function(a){i({message:m(a)})})}var r,s,t=encodeURIComponent(c.renameFileWhileKeepingExtension(d.name,e(g.filename,g))),u=g.uploadMethod.dataSource,v=u&&u.serviceUrl?u.serviceUrl:"",w={row:f.row,model:f.model},x={createFields:!1},y=f.options.xmlDef.attr("foldername"),z=y?encodeURIComponent(e(y,w,x)):encodeURIComponent("/Shared Documents"),A="/web/getfolderbyserverrelativeurl('"+z+"')/files/getbyurl('"+t+"')/",B=c.rfc4122v4GUID(),C=d.size,D=a.platform.getMaxProxyRequestPayload(),E=1;C&&(g.dataSource=u,c.readFileAsBase64(d).then(function(a){s=a,r=Math.ceil(C/D),1===r?l(g).then(function(){n(s,{overwrite:!0}).then(function(){i()},function(a){i({message:m(a)})})}):l(g).then(function(){s=k(s,r),g.headers.Accept="application/json; odata=verbose",n("42",{overwrite:!1}).then(o,function(a){var b=m(a);b.includes("already exists")?o():i({message:b})})})}))}return{relative_server_url:{label:"Relative Server URL",upload:d,hasDescription:!1,hasParent:!1,builderProps:[{id:"foldername",type:"text",label:"Relative folder URL",defaultValue:"/Shared Documents",helptext:'This is the relative server url for the folder you want this file to be uploaded to. Example: "/Shared Documents/SubFolder1/SubFolder2"'}]}}}};new a.dataSource.DataSourceType(n)}}(skuid);